name: Issue Closed Celebration

on:
  issues:
    types: [closed]

jobs:
  issue-closed-handler:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: read
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Process closed issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è·å–issueä¿¡æ¯
          ISSUE_NUMBER=${{ github.event.issue.number }}
          ISSUE_AUTHOR="${{ github.event.issue.user.login }}"
          CREATED_AT="${{ github.event.issue.created_at }}"
          CLOSED_AT="${{ github.event.issue.closed_at }}"
          
          echo "Issue #$ISSUE_NUMBER closed by $ISSUE_AUTHOR"
          echo "Created at: $CREATED_AT"
          echo "Closed at: $CLOSED_AT"

          # è·å–åˆ†é…çš„ç®¡ç†äººå‘˜
          ASSIGNEES_JSON=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${ISSUE_NUMBER}")
          
          ASSIGNEE_LIST=$(echo "$ASSIGNEES_JSON" | jq -r '.assignees[]?.login' | tr '\n' ' ' | sed 's/ $//')
          echo "Assignees: $ASSIGNEE_LIST"

          # è·å–ä»issueåˆ›å»ºåˆ°å…³é—­æœŸé—´çš„æ‰€æœ‰æäº¤
          TOP_USER=""
          TOP_USER_LOGIN=""
          TOP_COUNT=0
          HAS_COMMITS=false
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æäº¤
          if git log --since="$CREATED_AT" --until="$CLOSED_AT" --oneline > /dev/null 2>&1; then
            # è·å–æäº¤è€…çš„é‚®ç®±ï¼ˆæ›´å¯é ï¼‰
            COMMITS=$(git log --since="$CREATED_AT" --until="$CLOSED_AT" --pretty=format:"%ae" | sort | uniq -c | sort -nr)
            if [ -n "$COMMITS" ] && [ "$COMMITS" != "" ]; then
              HAS_COMMITS=true
              TOP_CONTRIBUTOR=$(echo "$COMMITS" | head -n 1)
              TOP_COUNT=$(echo "$TOP_CONTRIBUTOR" | awk '{print $1}')
              TOP_EMAIL=$(echo "$TOP_CONTRIBUTOR" | awk '{$1=""; print $0}' | sed 's/^ *//')
              
              echo "Top contributor email: $TOP_EMAIL with $TOP_COUNT commits"
              
              # å°è¯•é€šè¿‡é‚®ç®±æŸ¥æ‰¾GitHubç”¨æˆ·å
              if [ -n "$TOP_EMAIL" ]; then
                # æœç´¢GitHubç”¨æˆ·ï¼ˆé€šè¿‡commitæœç´¢ï¼‰
                USER_SEARCH=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
                  -H "Accept: application/vnd.github.v3+json" \
                  "https://api.github.com/search/users?q=$TOP_EMAIL+in:email")
                
                TOP_USER_LOGIN=$(echo "$USER_SEARCH" | jq -r '.items[0].login // empty')
                
                if [ -n "$TOP_USER_LOGIN" ]; then
                  echo "Found GitHub user: $TOP_USER_LOGIN"
                else
                  # å¦‚æœæ‰¾ä¸åˆ°ï¼Œä½¿ç”¨æäº¤è€…åç§°ä½œä¸ºå¤‡é€‰
                  TOP_USER=$(git log --since="$CREATED_AT" --until="$CLOSED_AT" --pretty=format:"%an" | sort | uniq -c | sort -nr | head -n 1 | awk '{$1=""; print $0}' | sed 's/^ *//')
                  echo "Using commit name as fallback: $TOP_USER"
                fi
              fi
            fi
          fi

          # è·å–issueçš„æ‰€æœ‰è¯„è®º
          echo "Fetching issue comments..."
          COMMENTS_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/comments?per_page=100")
          
          # ç»Ÿè®¡è¯„è®º
          TOTAL_COMMENTS=0
          COMMENTERS_JSON=$(echo "$COMMENTS_RESPONSE" | jq -r '.[] | select(.user.login != "'$ISSUE_AUTHOR'") | .user.login')
          
          if [ -n "$COMMENTERS_JSON" ]; then
            TOTAL_COMMENTS=$(echo "$COMMENTERS_JSON" | wc -l)
            echo "Total comments (excluding author): $TOTAL_COMMENTS"
            
            # æ‰¾å‡ºæœ€å¤šè¯„è®ºçš„ç”¨æˆ·
            TOP_COMMENTER=$(echo "$COMMENTERS_JSON" | sort | uniq -c | sort -nr | head -n 1)
            TOP_COMMENT_COUNT=$(echo "$TOP_COMMENTER" | awk '{print $1}')
            TOP_COMMENTER_LOGIN=$(echo "$TOP_COMMENTER" | awk '{$1=""; print $0}' | sed 's/^ *//')
            
            echo "Top commenter: $TOP_COMMENTER_LOGIN with $TOP_COMMENT_COUNT comments"
          fi

          # æ„å»ºæ¶ˆæ¯
          MESSAGE="@$ISSUE_AUTHOR ä½ çš„é—®é¢˜è§£å†³å•¦ï¼Œå˜»å˜» ğŸ‰\n\n"
          
          # å¦‚æœæœ‰åˆ†é…çš„ç®¡ç†äººå‘˜ï¼Œæ„Ÿè°¢ä»–ä»¬
          if [ -n "$ASSIGNEE_LIST" ] && [ "$ASSIGNEE_LIST" != "null" ]; then
            # ä¸ºæ¯ä¸ªåˆ†é…è€…æ·»åŠ @
            ASSIGNEE_MENTIONS=""
            for assignee in $ASSIGNEE_LIST; do
              ASSIGNEE_MENTIONS+="@$assignee "
            done
            MESSAGE+="$ASSIGNEE_MENTIONS æ„Ÿè°¢ä½ ä»¬çš„ä»˜å‡ºï¼ğŸ‘\n\n"
          else
            MESSAGE+="æ„Ÿè°¢æ‰€æœ‰å‚ä¸è§£å†³é—®é¢˜çš„è´¡çŒ®è€…ï¼ğŸ‘\n\n"
          fi
          
          # ä»£ç è´¡çŒ®ç»Ÿè®¡
          MESSAGE+="**ä»£ç è´¡çŒ®ç»Ÿè®¡ï¼š**\n"
          if [ "$HAS_COMMITS" = true ] && [ "$TOP_COUNT" -gt 0 ]; then
            if [ -n "$TOP_USER_LOGIN" ]; then
              MESSAGE+="ğŸ† æœ€é«˜è´¡çŒ®ï¼š@$TOP_USER_LOGIN ï¼ˆ$TOP_COUNT æ¬¡æäº¤ï¼‰\n"
            elif [ -n "$TOP_USER" ]; then
              MESSAGE+="ğŸ† æœ€é«˜è´¡çŒ®ï¼š$TOP_USER ï¼ˆ$TOP_COUNT æ¬¡æäº¤ï¼‰\n"
            else
              MESSAGE+="ğŸ† æœ€é«˜è´¡çŒ®ï¼šåŒ¿åè´¡çŒ®è€… ï¼ˆ$TOP_COUNT æ¬¡æäº¤ï¼‰\n"
            fi
          else
            MESSAGE+="ğŸ“Š æš‚æ— ä»£ç æäº¤æ•°æ®\n"
          fi
          
          # ç¤¾åŒºè¯„è®ºè´¡çŒ®ç»Ÿè®¡
          MESSAGE+="\n**ç¤¾åŒºäº’åŠ¨ç»Ÿè®¡ï¼š**\n"
          if [ "$TOTAL_COMMENTS" -gt 0 ]; then
            if [ -n "$TOP_COMMENTER_LOGIN" ] && [ "$TOP_COMMENT_COUNT" -gt 0 ]; then
              MESSAGE+="ğŸ’¬ æœ€æ´»è·ƒå›å¤ï¼š@$TOP_COMMENTER_LOGIN ï¼ˆ$TOP_COMMENT_COUNT æ¬¡å›å¤ï¼‰\n"
            fi
            MESSAGE+="ğŸ“ æ€»å›å¤æ•°ï¼š$TOTAL_COMMENTS æ¡\n"
          else
            MESSAGE+="ğŸ’¬ æš‚æ— ç¤¾åŒºå›å¤æ•°æ®\n"
          fi

          MESSAGE+="\næ„Ÿè°¢å¤§å®¶çš„å…±åŒåŠªåŠ›ï¼â¤ï¸"

          # æ·»åŠ è¯„è®ºåˆ°å·²å…³é—­çš„issue
          JSON_BODY=$(jq -n --arg body "$(echo -e "$MESSAGE")" '{"body": $body}')
          
          curl -s -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               -X POST \
               -d "$JSON_BODY" \
               "https://api.github.com/repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/comments"

          echo "Comment added to issue #$ISSUE_NUMBER"
          echo "Final message:"
          echo -e "$MESSAGE"
